<!DOCTYPE html>
<html>
<head>
    <title>Админ-панель</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="admin-panel">
        <h2>Добавить товар</h2>
        <form id="product-form">
            <input type="text" name="name" placeholder="Название" required>
            <input type="number" name="price" placeholder="Цена в звездах" required>
            <textarea name="description" placeholder="Описание"></textarea>
            <select name="category" class="form-select mb-3">
                <option value="popular">Популярные</option>
                <option value="new">Новинки</option>
            </select>
            <input type="url" name="image" placeholder="URL изображения" required>
            <button type="submit">Добавить товар</button>
        </form>
        <div id="message"></div>

        <div class="product-list mt-4">
            <h3>Список товаров</h3>
            <div id="products-list"></div>
        </div>
    </div>

    <script>
        // Объединенный код для управления товарами
        const productForm = document.getElementById('product-form');
        const productsList = document.getElementById('products-list');

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = Object.fromEntries(new FormData(e.target));

            try {
                const response = await fetch('/api/products', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                showMessage(result, 'Товар успешно добавлен!');
                result.status === 'success' && (e.target.reset(), loadProducts());
            } catch (error) {
                showMessage({status: 'error', message: error.message});
            }
        });

        async function loadProducts() {
            const response = await fetch('/api/products');
            const products = await response.json();
            productsList.innerHTML = products.map(p => `
                <div class="product-item mb-3">
                    <div>${p.name} (${p.price} ⭐)</div>
                    <button onclick="deleteProduct(${p.id})" class="btn btn-sm btn-danger">Удалить</button>
                </div>
            `).join('');
        }

        async function deleteProduct(id) {
            await fetch(`/api/products/${id}`, {method: 'DELETE'});
            const cart = JSON.parse(localStorage.getItem('marketplace_cart')) || [];
            localStorage.setItem('marketplace_cart', JSON.stringify(cart.filter(item => item.product.id !== id)));
            loadProducts();
        }

        function showMessage({status, message}, successText) {
            document.getElementById('message').innerHTML = `
                <div class="alert alert-${status} mt-3">
                    ${status === 'success' ? successText : `Ошибка: ${message}`}
                </div>
            `;
        }

        loadProducts();
    </script>
</body>
</html>